<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Fixes Test</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
</head>
<body>
    <div x-data="{
        testData: [
            { id: 1, name: 'Test 1' },
            { id: 2, name: 'Test 2' }
        ],
        addProfileContextMenu: function(element, profile) {
            try {
                if (!element || !element.addEventListener) {
                    console.warn('addProfileContextMenu: Invalid element provided');
                    return;
                }
                console.log('Context menu added for:', profile.name);
            } catch (error) {
                console.error('Error adding profile context menu:', error);
            }
        }
    }">
        <h1>JavaScript Fixes Test</h1>
        
        <!-- Test 1: Fixed duplicate keys in x-for -->
        <div>
            <h2>Test 1: Fixed Duplicate Keys</h2>
            <p>Process Flow Limited (should have unique keys like process-flow-limited-0, process-flow-limited-1):</p>
            <template x-for="(item, index) in testData.slice(0, 2)" :key="`process-flow-limited-${index}`">
                <div x-text="`Item ${index}: ${item.name}`"></div>
            </template>
            
            <p>Process Flow All (should have unique keys like process-flow-all-0, process-flow-all-1):</p>
            <template x-for="(item, index) in testData" :key="`process-flow-all-${index}`">
                <div x-text="`Item ${index}: ${item.name}`"></div>
            </template>
        </div>
        
        <!-- Test 2: Fixed function scope with defensive coding -->
        <div>
            <h2>Test 2: Fixed Function Scope</h2>
            <template x-for="item in testData" :key="`profile-test-${item.id}`">
                <div x-init="$nextTick(() => { if (addProfileContextMenu && typeof addProfileContextMenu === 'function') addProfileContextMenu($el, item); })"
                     x-text="`Profile: ${item.name}`"></div>
            </template>
        </div>
        
        <!-- Test 3: Error handling -->
        <div>
            <h2>Test 3: Enhanced Error Handling</h2>
            <button @click="console.log('Error handling enhanced with CDN library error prevention')">Test Enhanced Error Handling</button>
        </div>
    </div>
    
    <script>
        // Test global error handler
        window.addEventListener('error', function(event) {
            console.log('Error handler working:', event.message);
            if (event.filename && event.filename.includes('cdn.min.js')) {
                console.log('CDN error handling active');
                event.preventDefault();
            }
        });
        
        console.log('JavaScript fixes test loaded successfully');
        
        // Test the fixes after Alpine.js loads
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized - all fixes should be active');
        });
    </script>
</body>
</html>