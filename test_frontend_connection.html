<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .pending { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Frontend Connection Test</h1>
    <p>Testing API connectivity and WebSocket behavior isolated from main application</p>

    <div>
        <button onclick="testBasicAPI()">Test Basic API</button>
        <button onclick="testSystemStatus()">Test System Status</button>
        <button onclick="testWebSocketConnection()">Test WebSocket</button>
        <button onclick="testAPISequence()">Test API Sequence</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div>
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <div>
        <h2>Debug Log</h2>
        <div id="log"></div>
    </div>

    <script>
        let wsConnection = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function addResult(test, status, message) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status}`;
            resultDiv.innerHTML = `<strong>${test}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }
        
        async function testBasicAPI() {
            log('Starting basic API test...');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                log(`Health check response: ${JSON.stringify(data)}`);
                addResult('Basic API', 'success', `Health check successful: ${data.message || 'OK'}`);
            } catch (error) {
                log(`Basic API test failed: ${error.message}`);
                addResult('Basic API', 'error', `Failed: ${error.message}`);
            }
        }
        
        async function testSystemStatus() {
            log('Testing system status API...');
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                log(`System status response: ${JSON.stringify(data)}`);
                addResult('System Status API', 'success', `${data.processors_available || 0} processors available`);
            } catch (error) {
                log(`System status test failed: ${error.message}`);
                addResult('System Status API', 'error', `Failed: ${error.message}`);
            }
        }
        
        function testWebSocketConnection() {
            log('Testing WebSocket connection...');
            
            if (wsConnection) {
                wsConnection.close();
            }
            
            try {
                const wsUrl = `ws://localhost:8000/ws/progress`;
                wsConnection = new WebSocket(wsUrl);
                
                wsConnection.onopen = function(event) {
                    log('WebSocket connected successfully');
                    addResult('WebSocket Connection', 'success', 'Connected to /ws/progress');
                };
                
                wsConnection.onmessage = function(event) {
                    log(`WebSocket message received: ${event.data}`);
                };
                
                wsConnection.onerror = function(error) {
                    log(`WebSocket error: ${error}`);
                    addResult('WebSocket Connection', 'error', 'WebSocket connection failed');
                };
                
                wsConnection.onclose = function(event) {
                    log(`WebSocket closed: code=${event.code}, reason=${event.reason}`);
                    if (event.code !== 1000) {
                        addResult('WebSocket Connection', 'error', `WebSocket closed unexpectedly: ${event.code}`);
                    }
                };
                
                // Test timeout
                setTimeout(() => {
                    if (wsConnection && wsConnection.readyState === WebSocket.CONNECTING) {
                        log('WebSocket connection timeout');
                        addResult('WebSocket Connection', 'error', 'Connection timeout');
                        wsConnection.close();
                    }
                }, 5000);
                
            } catch (error) {
                log(`WebSocket test failed: ${error.message}`);
                addResult('WebSocket Connection', 'error', `Failed to create WebSocket: ${error.message}`);
            }
        }
        
        async function testAPISequence() {
            log('Testing API call sequence (simulating main app behavior)...');
            addResult('API Sequence', 'pending', 'Running sequence test...');
            
            const apis = [
                { name: 'Health', url: '/health' },
                { name: 'Dashboard Overview', url: '/api/dashboard/overview' },
                { name: 'System Status', url: '/api/system/status' },
                { name: 'Analytics Overview', url: '/api/analytics/overview' }
            ];
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const api of apis) {
                try {
                    log(`Testing ${api.name} API...`);
                    const start = performance.now();
                    const response = await fetch(api.url);
                    const end = performance.now();
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`${api.name} API success (${Math.round(end - start)}ms): ${JSON.stringify(data).substring(0, 100)}...`);
                        successCount++;
                    } else {
                        log(`${api.name} API failed with status: ${response.status}`);
                        errorCount++;
                    }
                } catch (error) {
                    log(`${api.name} API error: ${error.message}`);
                    errorCount++;
                }
                
                // Small delay between calls to simulate real usage
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (errorCount === 0) {
                addResult('API Sequence', 'success', `All ${successCount} API calls successful`);
            } else {
                addResult('API Sequence', 'error', `${errorCount} API calls failed, ${successCount} succeeded`);
            }
        }
        
        // Run basic connection test on load
        window.onload = function() {
            log('Frontend connection test page loaded');
            setTimeout(() => {
                log('Running initial health check...');
                testBasicAPI();
            }, 1000);
        };
        
        // Cleanup WebSocket on page unload
        window.onbeforeunload = function() {
            if (wsConnection) {
                wsConnection.close();
            }
        };
    </script>
</body>
</html>