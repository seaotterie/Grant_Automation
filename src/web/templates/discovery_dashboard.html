<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Dashboard - Catalynx</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/tailwindcss-cdn@3.4.0/tailwindcss.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .animate-pulse-custom { animation: pulse-custom 2s infinite; }
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>

<body class="bg-gray-50 min-h-screen" x-data="discoveryDashboard()" x-init="init()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">Discovery Dashboard</h1>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" :class="isConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                        <span class="text-sm text-gray-600" x-text="isConnected ? 'Live Updates' : 'Disconnected'"></span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <select x-model="selectedProfile" @change="loadProfileData()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Profiles</option>
                        <template x-for="profile in profiles" :key="profile.profile_id">
                            <option :value="profile.profile_id" x-text="profile.organization_name || profile.profile_id"></option>
                        </template>
                    </select>
                    
                    <button @click="startDiscoverySession()" :disabled="!selectedProfile" 
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        Start Discovery
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Real-Time Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Sessions</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="stats.activeSessions"></dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Opportunities</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="stats.totalOpportunities"></dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg Score</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="(stats.avgScore * 100).toFixed(1) + '%'"></dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/>
                                <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Success Rate</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="(stats.successRate * 100).toFixed(1) + '%'"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Discovery Sessions Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Discovery Sessions (24h)</h3>
                <canvas id="sessionsChart" width="400" height="200"></canvas>
            </div>

            <!-- Opportunity Sources Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Opportunity Sources</h3>
                <canvas id="sourcesChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Live Session Monitor -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6" x-show="currentSession" x-cloak>
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <span class="animate-pulse-custom w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                Live Discovery Session
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" x-text="currentSession?.totalResults || 0"></div>
                    <div class="text-sm text-gray-500">Opportunities Found</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" x-text="currentSession?.executionTime || 0"></div>
                    <div class="text-sm text-gray-500">Seconds Elapsed</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600" x-text="currentSession?.apiCalls || 0"></div>
                    <div class="text-sm text-gray-500">API Calls Made</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                     :style="'width: ' + (currentSession?.progress || 0) + '%'"></div>
            </div>

            <div class="text-sm text-gray-600" x-text="currentSession?.status || 'Running...'"></div>
        </div>

        <!-- Recent Sessions Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Recent Discovery Sessions</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profile</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Results</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sources</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="session in recentSessions" :key="session.session_id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" 
                                    x-text="getProfileName(session.profile_id)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                    x-text="formatDateTime(session.started_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                    x-text="session.execution_time_seconds + 's'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                    x-text="session.total_results_discovered"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="type in session.funding_types" :key="type">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800" 
                                                  x-text="type"></span>
                                        </template>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                          :class="getStatusColor(session.status)" 
                                          x-text="session.status"></span>
                                </td>
                            </tr>
                        </template>
                        
                        <tr x-show="recentSessions.length === 0">
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                No discovery sessions found
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function discoveryDashboard() {
            return {
                // Connection state
                isConnected: false,
                websocket: null,
                
                // Data
                profiles: [],
                selectedProfile: '',
                recentSessions: [],
                currentSession: null,
                
                // Stats
                stats: {
                    activeSessions: 0,
                    totalOpportunities: 0,
                    avgScore: 0,
                    successRate: 0
                },
                
                // Charts
                sessionsChart: null,
                sourcesChart: null,
                
                async init() {
                    await this.loadProfiles();
                    await this.loadRecentSessions();
                    await this.loadStats();
                    this.initCharts();
                    this.connectWebSocket();
                    
                    // Refresh data every 30 seconds
                    setInterval(() => {
                        this.loadRecentSessions();
                        this.loadStats();
                    }, 30000);
                },
                
                async loadProfiles() {
                    try {
                        const response = await fetch('/api/profiles');
                        this.profiles = await response.json();
                    } catch (error) {
                        console.error('Failed to load profiles:', error);
                    }
                },
                
                async loadRecentSessions() {
                    try {
                        const url = this.selectedProfile 
                            ? `/api/profiles/${this.selectedProfile}/discovery/sessions`
                            : '/api/discovery/sessions/recent';
                        const response = await fetch(url);
                        this.recentSessions = await response.json();
                    } catch (error) {
                        console.error('Failed to load recent sessions:', error);
                    }
                },
                
                async loadProfileData() {
                    if (!this.selectedProfile) return;
                    
                    await this.loadRecentSessions();
                    await this.loadStats();
                    this.updateCharts();
                },
                
                async loadStats() {
                    try {
                        const url = this.selectedProfile 
                            ? `/api/profiles/${this.selectedProfile}/analytics/real-time`
                            : '/api/discovery/stats/global';
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        this.stats = {
                            activeSessions: data.active_sessions || 0,
                            totalOpportunities: data.total_opportunities || 0,
                            avgScore: data.avg_score || 0,
                            successRate: data.success_rate || 0
                        };
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                initCharts() {
                    // Sessions Chart
                    const sessionsCtx = document.getElementById('sessionsChart').getContext('2d');
                    this.sessionsChart = new Chart(sessionsCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${23-i}h`),
                            datasets: [{
                                label: 'Discovery Sessions',
                                data: Array.from({length: 24}, () => Math.floor(Math.random() * 10)),
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // Sources Chart
                    const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
                    this.sourcesChart = new Chart(sourcesCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Foundations', 'Government', 'Commercial', 'State'],
                            datasets: [{
                                data: [45, 25, 20, 10],
                                backgroundColor: [
                                    'rgb(59, 130, 246)',
                                    'rgb(16, 185, 129)',
                                    'rgb(245, 158, 11)',
                                    'rgb(139, 92, 246)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                },
                
                updateCharts() {
                    // Update charts with profile-specific data
                    if (this.sessionsChart && this.sourcesChart) {
                        this.sessionsChart.update();
                        this.sourcesChart.update();
                    }
                },
                
                connectWebSocket() {
                    try {
                        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        this.websocket = new WebSocket(`${protocol}//${window.location.host}/ws/discovery`);
                        
                        this.websocket.onopen = () => {
                            this.isConnected = true;
                            console.log('WebSocket connected');
                        };
                        
                        this.websocket.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        };
                        
                        this.websocket.onclose = () => {
                            this.isConnected = false;
                            console.log('WebSocket disconnected');
                            // Reconnect after 5 seconds
                            setTimeout(() => this.connectWebSocket(), 5000);
                        };
                        
                        this.websocket.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            this.isConnected = false;
                        };
                    } catch (error) {
                        console.error('Failed to connect WebSocket:', error);
                        this.isConnected = false;
                    }
                },
                
                handleWebSocketMessage(data) {
                    switch(data.type) {
                        case 'session_start':
                            this.currentSession = data.session;
                            break;
                        case 'session_update':
                            if (this.currentSession && this.currentSession.session_id === data.session.session_id) {
                                Object.assign(this.currentSession, data.session);
                            }
                            break;
                        case 'session_complete':
                            if (this.currentSession && this.currentSession.session_id === data.session.session_id) {
                                this.currentSession = null;
                                this.loadRecentSessions();
                                this.loadStats();
                            }
                            break;
                        case 'stats_update':
                            Object.assign(this.stats, data.stats);
                            break;
                    }
                },
                
                async startDiscoverySession() {
                    if (!this.selectedProfile) return;
                    
                    try {
                        const response = await fetch(`/api/profiles/${this.selectedProfile}/discover`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                funding_types: ['grants', 'government', 'commercial'],
                                max_results_per_type: 50
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Discovery session started:', result.session_id);
                        }
                    } catch (error) {
                        console.error('Failed to start discovery session:', error);
                    }
                },
                
                // Utility methods
                getProfileName(profileId) {
                    const profile = this.profiles.find(p => p.profile_id === profileId);
                    return profile ? (profile.organization_name || profile.profile_id) : profileId;
                },
                
                formatDateTime(dateStr) {
                    if (!dateStr) return 'Unknown';
                    return new Date(dateStr).toLocaleString();
                },
                
                getStatusColor(status) {
                    switch(status) {
                        case 'completed':
                            return 'bg-green-100 text-green-800';
                        case 'running':
                            return 'bg-blue-100 text-blue-800';
                        case 'failed':
                            return 'bg-red-100 text-red-800';
                        default:
                            return 'bg-gray-100 text-gray-800';
                    }
                }
            }
        }
    </script>
</body>
</html>