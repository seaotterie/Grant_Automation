<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Tiers Demo - Catalynx</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js for reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">Catalynx</h1>
                        <span class="ml-3 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">Intelligence Demo</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        Grant Intelligence â€¢ Modular Analysis
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="intelligenceDemo()">
            
            <!-- Demo Introduction -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium text-blue-900">Intelligence Tier Selection Demo</h3>
                        <p class="mt-2 text-sm text-blue-700">
                            Experience our modular grant intelligence system. Select different tiers to see how analysis depth and value increase with each level.
                            This demo uses the <strong>Grantmakers In Aging Inc + DOE Test Grant</strong> scenario.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tier Selection Interface -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Select Intelligence Level</h2>
                
                <!-- Tier Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <template x-for="tier in tiers" :key="tier.id">
                        <div :class="[
                            'border-2 rounded-lg p-4 cursor-pointer transition-all duration-200',
                            selectedTier === tier.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300',
                            tier.status === 'coming_soon' ? 'opacity-60' : ''
                        ]" @click="selectTier(tier.id)" :disabled="tier.status === 'coming_soon'">
                            
                            <!-- Tier Header -->
                            <div class="text-center mb-4">
                                <h3 class="font-semibold text-lg" x-text="tier.name"></h3>
                                <div class="text-2xl font-bold text-blue-600" x-text="'$' + tier.price"></div>
                                <div class="text-sm text-gray-500" x-text="tier.delivery_time"></div>
                                <div x-show="tier.status === 'coming_soon'" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mt-2">
                                    Coming Soon
                                </div>
                            </div>
                            
                            <!-- Key Features -->
                            <div class="space-y-2">
                                <template x-for="feature in tier.features.slice(0, 3)" :key="feature">
                                    <div class="flex items-start text-sm">
                                        <svg class="h-4 w-4 text-green-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                        <span x-text="feature"></span>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Selection Indicator -->
                            <div x-show="selectedTier === tier.id" class="mt-4 text-center">
                                <span class="inline-flex items-center text-sm font-medium text-blue-600">
                                    <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Selected
                                </span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Cost Summary -->
                <div x-show="selectedTier" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-medium text-gray-900" x-text="getSelectedTierName() + ' Intelligence'"></h4>
                            <p class="text-sm text-gray-600" x-text="'Estimated delivery: ' + getSelectedTierTime()"></p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600" x-text="'$' + getSelectedTierPrice()"></div>
                            <div class="text-sm text-gray-500" x-text="'vs $' + getConsultantCost() + ' consultant'"></div>
                        </div>
                    </div>
                </div>

                <!-- Generate Analysis Button -->
                <div class="flex justify-center">
                    <button 
                        @click="generateAnalysis()"
                        :disabled="!selectedTier || loading || getSelectedTier()?.status === 'coming_soon'"
                        :class="[
                            'px-8 py-3 rounded-lg font-semibold transition-all duration-200',
                            (!selectedTier || loading || getSelectedTier()?.status === 'coming_soon') 
                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl'
                        ]"
                    >
                        <span x-show="!loading">Generate Intelligence Analysis</span>
                        <span x-show="loading" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div x-show="analysisResult" class="bg-white rounded-lg shadow-md p-6" x-transition>
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Analysis Results</h2>
                
                <!-- Success Message -->
                <div x-show="analysisResult?.status === 'completed'" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <svg class="h-5 w-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Analysis Completed Successfully</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p>Your <span x-text="selectedTierName"></span> intelligence analysis is ready.</p>
                                <p class="mt-1">Cost: <strong x-text="'$' + (analysisResult?.actual_cost || 'calculating...')"></strong> | 
                                   Time: <strong x-text="analysisResult?.estimated_completion_time || 'completed'"></strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Preview -->
                <div x-show="analysisResult?.result" class="space-y-4">
                    <!-- Standard Tier Results -->
                    <template x-if="selectedTier === 'standard' && analysisResult?.result">
                        <div class="space-y-4">
                            
                            <!-- Intelligence Score -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900">Intelligence Enhancement Score</h4>
                                <div class="flex items-center mt-2">
                                    <div class="flex-1 bg-blue-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full" :style="'width: ' + ((analysisResult.result.intelligence_score || 0) * 100) + '%'"></div>
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-blue-900" x-text="Math.round((analysisResult.result.intelligence_score || 0) * 100) + '%'"></span>
                                </div>
                                <p class="text-sm text-blue-700 mt-2">This analysis provides <strong x-text="Math.round((analysisResult.result.intelligence_score || 0) * 10) + 'x'"></strong> more intelligence than basic screening.</p>
                            </div>

                            <!-- Historical Intelligence Summary -->
                            <div x-show="analysisResult.result.historical_funding_intelligence" class="border border-gray-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-3">Historical Funding Intelligence</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-2xl font-bold text-blue-600" x-text="analysisResult.result.historical_funding_intelligence.total_awards || 0"></div>
                                        <div class="text-sm text-gray-600">Awards Found</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-green-600" x-text="'$' + (analysisResult.result.historical_funding_intelligence.total_funding || 0).toLocaleString()"></div>
                                        <div class="text-sm text-gray-600">Total Funding</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-purple-600" x-text="(analysisResult.result.historical_funding_intelligence.competitive_landscape || 'unknown').toUpperCase()"></div>
                                        <div class="text-sm text-gray-600">Competition</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-orange-600" x-text="(analysisResult.result.historical_funding_intelligence.market_size || 'unknown').toUpperCase()"></div>
                                        <div class="text-sm text-gray-600">Market Size</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Recommendations -->
                            <div x-show="analysisResult.result.enhanced_recommendations" class="border border-gray-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-3">Enhanced Recommendations</h4>
                                <ul class="space-y-2">
                                    <template x-for="(recommendation, index) in (analysisResult.result.enhanced_recommendations || [])" :key="index">
                                        <li class="flex items-start">
                                            <svg class="h-5 w-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                            </svg>
                                            <span class="text-sm text-gray-700" x-text="recommendation"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </template>

                    <!-- Other Tier Results -->
                    <template x-if="selectedTier !== 'standard' && analysisResult?.result">
                        <div class="bg-gray-50 p-6 rounded-lg text-center">
                            <h4 class="font-semibold text-gray-900 mb-2" x-text="getSelectedTierName() + ' Analysis'"></h4>
                            <p class="text-gray-600 mb-4" x-text="analysisResult.result.message || 'Analysis completed successfully'"></p>
                            <div x-show="analysisResult.result.status === 'coming_soon_in_next_release'" 
                                 class="text-sm text-orange-600 bg-orange-100 px-3 py-1 rounded-full inline-block">
                                Available in next release
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Error Display -->
            <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6" x-transition>
                <div class="flex">
                    <svg class="h-5 w-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Analysis Error</h3>
                        <p class="mt-2 text-sm text-red-700" x-text="error"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function intelligenceDemo() {
            return {
                selectedTier: 'current',
                selectedTierName: 'Current',
                loading: false,
                analysisResult: null,
                error: null,
                
                tiers: [
                    {
                        id: 'current',
                        name: 'Current Intelligence',
                        price: '0.75',
                        delivery_time: '5-10 minutes',
                        poc_effort: '0 hours',
                        features: [
                            '4-Stage AI Analysis (PLAN, ANALYZE, EXAMINE, APPROACH)',
                            'Multi-dimensional scoring and risk assessment',
                            'Success probability modeling (75-80% confidence)',
                            'Implementation roadmap with resource allocation'
                        ],
                        best_for: ['Quick opportunity assessment', 'Initial screening', 'Budget-conscious analysis']
                    },
                    {
                        id: 'standard',
                        name: 'Standard Intelligence',
                        price: '7.50',
                        delivery_time: '15-20 minutes',
                        poc_effort: '0 hours',
                        features: [
                            'Everything in Current Intelligence',
                            '5-year historical funding analysis',
                            'Award pattern intelligence and success factors',
                            'Geographic distribution and competitive analysis',
                            'Temporal trends and market timing insights'
                        ],
                        best_for: ['Serious opportunity pursuit', 'Proposal development', 'Competitive intelligence']
                    },
                    {
                        id: 'enhanced',
                        name: 'Enhanced Intelligence',
                        price: '22.00',
                        delivery_time: '30-45 minutes',
                        poc_effort: '0-1 hours',
                        features: [
                            'Everything in Standard Intelligence',
                            'Complete RFP/NOFO analysis and requirements extraction',
                            'Board network intelligence and relationship mapping',
                            'Decision maker profiles and engagement strategies',
                            'Strategic partnership opportunity identification'
                        ],
                        best_for: ['High-value opportunities', 'Strategic partnerships', 'Relationship-driven funding'],
                        status: 'coming_soon'
                    },
                    {
                        id: 'complete',
                        name: 'Complete Intelligence',
                        price: '42.00',
                        delivery_time: '60-90 minutes',
                        poc_effort: '2-4 hours',
                        features: [
                            'Everything in Enhanced Intelligence',
                            'Masters thesis-level comprehensive analysis',
                            'Advanced network mapping and warm introduction pathways',
                            'Policy context analysis and regulatory insights',
                            'Real-time monitoring and premium documentation'
                        ],
                        best_for: ['Major institutional opportunities', 'Multi-million dollar programs', 'Complex partnerships'],
                        status: 'coming_soon'
                    }
                ],

                selectTier(tierId) {
                    if (this.getSelectedTier()?.status === 'coming_soon') return;
                    
                    this.selectedTier = tierId;
                    this.selectedTierName = this.getSelectedTierName();
                    this.analysisResult = null;
                    this.error = null;
                },

                getSelectedTier() {
                    return this.tiers.find(t => t.id === this.selectedTier);
                },

                getSelectedTierName() {
                    return this.getSelectedTier()?.name || '';
                },

                getSelectedTierPrice() {
                    return this.getSelectedTier()?.price || '0';
                },

                getSelectedTierTime() {
                    return this.getSelectedTier()?.delivery_time || '';
                },

                getConsultantCost() {
                    const costs = { current: '200', standard: '400', enhanced: '800', complete: '1500' };
                    return costs[this.selectedTier] || '400';
                },

                async generateAnalysis() {
                    if (!this.selectedTier || this.loading) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.analysisResult = null;

                    try {
                        const response = await fetch('/api/intelligence/profiles/test-profile/analysis', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                opportunity_id: 'test-doe-grant',
                                tier: this.selectedTier,
                                add_ons: []
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.detail || 'Analysis failed');
                        }

                        this.analysisResult = data;

                        // If it's a background task, poll for results
                        if (data.task_id) {
                            await this.pollTaskResult(data.task_id);
                        }

                    } catch (err) {
                        this.error = err.message;
                        console.error('Analysis error:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                async pollTaskResult(taskId) {
                    let attempts = 0;
                    const maxAttempts = 30; // 5 minutes max

                    const poll = async () => {
                        try {
                            const response = await fetch(`/api/intelligence/analysis/${taskId}`);
                            const data = await response.json();

                            if (data.status === 'completed') {
                                this.analysisResult.result = data.result;
                                this.analysisResult.actual_cost = data.processing_cost;
                                this.analysisResult.status = 'completed';
                                return;
                            }

                            if (data.status === 'failed') {
                                throw new Error(data.error_message || 'Task failed');
                            }

                            attempts++;
                            if (attempts < maxAttempts) {
                                setTimeout(poll, 10000); // Poll every 10 seconds
                            } else {
                                throw new Error('Analysis timeout');
                            }

                        } catch (err) {
                            this.error = err.message;
                        }
                    };

                    setTimeout(poll, 2000); // Start polling after 2 seconds
                }
            }
        }
    </script>
</body>
</html>