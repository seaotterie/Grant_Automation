<!-- ============================================================ -->
<!-- PROFILE MODALS - Phase 9 Week 4                             -->
<!-- ============================================================ -->
<!--
    This file contains all profile-related modal templates.
    To integrate: Insert before </body> tag in index.html

    Modals included:
    1. Edit Profile Modal (5 tabs)
    2. NTEE Code Selection Modal (nested)
    3. Government Criteria Selection Modal (nested)
    4. Create Profile Modal (2 modes)
    5. Delete Profile Modal (confirmation)
-->

<!-- ============================================================ -->
<!-- 1. EDIT PROFILE MODAL (5 TABS)                              -->
<!-- ============================================================ -->
<div x-data="{
        modalOpen: false,
        activeTab: 'basic',
        nteeSelectionModalOpen: false,
        tempNteeCodes: [],
        selectedMainCategory: null,
        governmentSelectionModalOpen: false,
        tempGovernmentCriteria: [],
        selectedGovernmentCategory: null,
        profile: {},
        loading: false,
        scrapingLoading: false,
        error: null,
        selectedFiles: [],
        uploadedFiles: [],
        init() {
            // Modal uses shared object reference - no event listeners needed
            // When profiles-module updates selectedProfile, modal's profile updates automatically

            // Listen for web scraping start
            window.addEventListener('run-tool-25', () => {
                console.log('[MODAL] Enhanced Search started, setting scrapingLoading = true');
                this.scrapingLoading = true;
            });

            // Listen for profile updates (includes web scraping completion)
            window.addEventListener('profile-updated', (event) => {
                console.log('[MODAL] Profile updated event received, setting scrapingLoading = false');
                console.log('[MODAL] Profile web_enhanced_data:', this.profile?.web_enhanced_data ? 'Present' : 'Missing');
                this.scrapingLoading = false;
            });
        },
        openNteeSelectionModal() {
            // Initialize temp codes with current profile codes
            this.tempNteeCodes = [...(this.profile.ntee_codes || [])];
            this.selectedMainCategory = null;
            this.nteeSelectionModalOpen = true;
        },
        closeNteeSelectionModal() {
            this.nteeSelectionModalOpen = false;
            this.selectedMainCategory = null;
        },
        selectMainCategory(categoryKey) {
            this.selectedMainCategory = categoryKey;
        },
        saveNteeSelection() {
            // Save temp codes to profile
            if (!this.profile.ntee_codes) {
                this.profile.ntee_codes = [];
            }
            this.profile.ntee_codes = [...this.tempNteeCodes];
            this.nteeSelectionModalOpen = false;
        },
        toggleTempNteeCode(code) {
            const index = this.tempNteeCodes.indexOf(code);
            if (index > -1) {
                this.tempNteeCodes.splice(index, 1);
            } else {
                this.tempNteeCodes.push(code);
            }
        },
        isTempCodeSelected(code) {
            return this.tempNteeCodes.includes(code);
        },
        categoryHasTempSelections(categoryKey) {
            // Access fullNteeCodeList from parent catalynxApp scope
            const fullList = this.fullNteeCodeList || {};
            if (!fullList[categoryKey]) return false;
            const categorySubcodes = fullList[categoryKey].subcategories.map(sub => sub.code);
            return this.tempNteeCodes.some(selectedCode => categorySubcodes.includes(selectedCode));
        },
        getNteeCodeName(code) {
            // Search through all categories to find the code name
            // Access fullNteeCodeList from parent catalynxApp scope
            const fullList = this.fullNteeCodeList || {};
            for (const categoryKey in fullList) {
                const category = fullList[categoryKey];
                const subcat = category.subcategories?.find(sub => sub.code === code);
                if (subcat) {
                    return subcat.name;
                }
            }
            return 'Unknown Code';
        },
        // Government Criteria Modal Functions
        openGovernmentSelectionModal() {
            this.tempGovernmentCriteria = [...(this.profile.government_criteria || [])];
            this.selectedGovernmentCategory = null;
            this.governmentSelectionModalOpen = true;
        },
        closeGovernmentSelectionModal() {
            this.governmentSelectionModalOpen = false;
            this.selectedGovernmentCategory = null;
        },
        saveGovernmentSelection() {
            if (!this.profile.government_criteria) {
                this.profile.government_criteria = [];
            }
            this.profile.government_criteria = [...this.tempGovernmentCriteria];
            this.governmentSelectionModalOpen = false;
        },
        selectGovernmentCategory(categoryKey) {
            this.selectedGovernmentCategory = categoryKey;
        },
        toggleGovernmentCriteria(criteriaId) {
            const index = this.tempGovernmentCriteria.indexOf(criteriaId);
            if (index > -1) {
                this.tempGovernmentCriteria.splice(index, 1);
            } else {
                this.tempGovernmentCriteria.push(criteriaId);
            }
        },
        isGovernmentCriteriaSelected(criteriaId) {
            return this.tempGovernmentCriteria.includes(criteriaId);
        },
        categoryHasGovernmentSelections(categoryKey) {
            const list = this.governmentCriteriaList || {};
            if (!list[categoryKey]) return false;
            const categoryCriteriaIds = list[categoryKey].criteria.map(c => c.id);
            return this.tempGovernmentCriteria.some(id => categoryCriteriaIds.includes(id));
        },
        getGovernmentCriteriaName(criteriaId) {
            const list = this.governmentCriteriaList || {};
            for (const categoryKey in list) {
                const criteria = list[categoryKey].criteria?.find(c => c.id === criteriaId);
                if (criteria) return criteria.name;
            }
            return 'Unknown Criteria';
        },
        refreshProfile(updatedProfile) {
            // Update profile properties to trigger Alpine reactivity
            Object.keys(updatedProfile).forEach(key => {
                this.profile[key] = updatedProfile[key];
            });
        },
        async saveProfile() {
            const profileId = this.profile?.profile_id || this.profile?.id;
            if (!this.profile || !profileId) {
                this.error = 'No profile to save or missing ID';
                return;
            }

            this.loading = true;
            this.error = null;
            try {
                // Clean up profile data - remove organization_name if present (should be 'name')
                const profileData = {...this.profile};
                if (profileData.organization_name && !profileData.name) {
                    profileData.name = profileData.organization_name;
                    delete profileData.organization_name;
                }

                // Don't save placeholder text - convert to null
                if (profileData.ntee_code_990 === 'None Found - Enter Manually (optional)') {
                    profileData.ntee_code_990 = null;
                }

                console.log('Cleaned profile data:', profileData);

                const response = await fetch(`/api/profiles/${profileId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Update failed: ${response.statusText}`);
                }

                const result = await response.json();
                window.dispatchEvent(new CustomEvent('profile-updated', { detail: result }));
                this.modalOpen = false;
            } catch (error) {
                console.error('Save profile failed:', error);
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        },
        // File Upload Methods
        triggerFileInput() {
            this.$refs.fileInput.click();
        },
        handleFileSelect(event) {
            const files = Array.from(event.target.files || []);
            this.selectedFiles = files;
            console.log('Files selected:', files.map(f => f.name));
        },
        removeFile(index) {
            this.selectedFiles.splice(index, 1);
        },
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        },
        async uploadFiles() {
            if (this.selectedFiles.length === 0) return;

            const profileId = this.profile?.profile_id || this.profile?.id;
            if (!profileId) {
                this.error = 'No profile ID for file upload';
                return;
            }

            const formData = new FormData();
            this.selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            formData.append('profile_id', profileId);

            try {
                // Note: This endpoint may need to be created on the backend
                const response = await fetch(`/api/profiles/${profileId}/upload-files`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    // Add uploaded files to the list
                    this.uploadedFiles = result.files || [];
                    this.selectedFiles = [];
                    this.$refs.fileInput.value = '';
                } else {
                    throw new Error('File upload failed');
                }
            } catch (error) {
                console.error('File upload error:', error);
                this.error = 'File upload failed: ' + error.message;
            }
        }
     }"
     x-show="modalOpen"
     x-cloak
     @open-edit-profile-modal.window="modalOpen = true; profile = $event.detail.profile; activeTab = 'basic'"
     @close-edit-profile-modal.window="modalOpen = false"
     @profile-research-complete.window="refreshProfile($event.detail.profile)"
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;">

    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
         @click="modalOpen = false"
         x-show="modalOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>

    <!-- Modal Container -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden"
             @click.stop
             x-show="modalOpen"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95">

            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Edit Organization Profile</h3>
                <button @click="modalOpen = false"
                        class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <div class="flex overflow-x-auto">
                    <button @click="activeTab = 'basic'"
                            :class="activeTab === 'basic' ? 'border-purple-500 text-purple-600 dark:text-purple-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="px-6 py-3 border-b-2 font-medium text-sm whitespace-nowrap transition-colors">
                        Basic Information
                    </button>
                    <button @click="activeTab = 'ntee'"
                            :class="activeTab === 'ntee' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="px-6 py-3 border-b-2 font-medium text-sm whitespace-nowrap transition-colors flex items-center">
                        NTEE Codes
                        <span x-show="profile.ntee_codes && profile.ntee_codes.length > 0"
                              class="ml-2 px-2 py-0.5 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full"
                              x-text="'Phase 2'"></span>
                    </button>
                    <button @click="activeTab = 'government'"
                            :class="activeTab === 'government' ? 'border-purple-500 text-purple-600 dark:text-purple-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="px-6 py-3 border-b-2 font-medium text-sm whitespace-nowrap transition-colors flex items-center">
                        Government Criteria
                        <span x-show="profile.government_criteria && profile.government_criteria.length > 0"
                              class="ml-2 px-2 py-0.5 text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded-full"
                              x-text="'Phase 3'"></span>
                    </button>
                    <button @click="activeTab = 'enhanced'"
                            :class="activeTab === 'enhanced' ? 'border-green-500 text-green-600 dark:text-green-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="px-6 py-3 border-b-2 font-medium text-sm whitespace-nowrap transition-colors">
                        Enhanced Data
                    </button>
                    <button @click="activeTab = 'userspecific'"
                            :class="activeTab === 'userspecific' ? 'border-orange-500 text-orange-600 dark:text-orange-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="px-6 py-3 border-b-2 font-medium text-sm whitespace-nowrap transition-colors">
                        User Specific
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">

                <!-- TAB 1: BASIC INFORMATION -->
                <div x-show="activeTab === 'basic'" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Organization Name with Research Button -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Organization Name <span class="text-red-500">*</span>
                            </label>
                            <div class="flex items-center space-x-2">
                                <input type="text"
                                       x-model="profile.name"
                                       class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white">
                                <button @click="$dispatch('research-profile', { ein: profile.ein })"
                                        :disabled="!profile.ein"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
                                    Research
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Research scrubs IRS 990 filing for Website, NTEE Code, Mission, and Keywords
                            </p>
                        </div>

                        <!-- EIN -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                EIN (Tax ID) <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   x-model="profile.ein"
                                   disabled
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white cursor-not-allowed">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">EIN cannot be changed</p>
                        </div>

                        <!-- Profile's NTEE Code (from 990) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Profile's NTEE Code
                            </label>
                            <input type="text"
                                   x-model="profile.ntee_code_990"
                                   placeholder="Auto-filled by Research button, or enter manually (optional)"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Auto-populated from 990 filing data via Research button
                            </p>
                        </div>

                        <!-- Website URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Website URL
                            </label>
                            <input type="url"
                                   x-model="profile.website_url"
                                   placeholder="https://example.org"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Organization's official website (used for web intelligence)
                            </p>
                        </div>

                        <!-- Organization Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Organization Type
                            </label>
                            <select x-model="profile.organization_type"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white">
                                <option value="">Select Type</option>
                                <option value="nonprofit">Nonprofit</option>
                                <option value="501c3">501(c)(3) Public Charity</option>
                                <option value="foundation">Private Foundation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Mission Statement -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Mission Statement
                            </label>
                            <span class="text-xs text-gray-500 dark:text-gray-400"
                                  x-text="(profile.mission_statement || '').length + '/1000 characters'"></span>
                        </div>
                        <textarea x-model="profile.mission_statement"
                                  rows="4"
                                  maxlength="1000"
                                  placeholder="Providing healthcare services to underserved communities"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white"></textarea>
                    </div>

                    <!-- Keywords -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Keywords
                        </label>
                        <textarea x-model="profile.keywords"
                                  rows="3"
                                  placeholder="Key terms and phrases that describe your work"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-white"></textarea>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Comma-separated keywords to improve opportunity matching
                        </p>
                    </div>
                </div>

                <!-- TAB 2: NTEE CODES (Selected List Only) -->
                <div x-show="activeTab === 'ntee'" class="h-[500px] flex flex-col">
                    <!-- Header with Select Button -->
                    <div class="px-4 py-3 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Selected NTEE Codes</h4>
                            <button @click="openNteeSelectionModal()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                Select NTEE Codes
                            </button>
                        </div>
                    </div>

                    <!-- Selected Codes Display -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <!-- Empty State -->
                        <div x-show="!profile.ntee_codes || profile.ntee_codes.length === 0"
                             class="text-center py-12 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 class="mt-4 text-sm font-medium text-gray-900 dark:text-white">No NTEE Codes Selected</h3>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                Click "Select NTEE Codes" to choose organizational classifications
                            </p>
                        </div>

                        <!-- Simple List of Selected Codes -->
                        <div x-show="profile.ntee_codes && profile.ntee_codes.length > 0" class="space-y-1">
                            <template x-for="code in (profile.ntee_codes || [])" :key="code">
                                <div class="flex items-start py-1">
                                    <span class="font-mono text-sm font-medium text-blue-600 dark:text-blue-400 w-16" x-text="code"></span>
                                    <span class="text-sm text-gray-700 dark:text-gray-200 flex-1" x-text="getNteeCodeName(code)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: GOVERNMENT CRITERIA (Selected List Only) -->
                <div x-show="activeTab === 'government'" class="h-[500px] flex flex-col">
                    <!-- Header with Select Button -->
                    <div class="px-4 py-3 bg-purple-50 dark:bg-purple-900/20 border-b border-purple-200 dark:border-purple-800">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Selected Government Criteria</h4>
                            <button @click="openGovernmentSelectionModal()"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium">
                                Select Government Criteria
                            </button>
                        </div>
                    </div>

                    <!-- Selected Criteria Display -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <!-- Empty State -->
                        <div x-show="!profile.government_criteria || profile.government_criteria.length === 0"
                             class="text-center py-12 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 class="mt-4 text-sm font-medium text-gray-900 dark:text-white">No Government Criteria Selected</h3>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                Click "Select Government Criteria" to choose funding criteria
                            </p>
                        </div>

                        <!-- Simple List of Selected Criteria -->
                        <div x-show="profile.government_criteria && profile.government_criteria.length > 0" class="space-y-1">
                            <template x-for="criteriaId in (profile.government_criteria || [])" :key="criteriaId">
                                <div class="flex items-start py-1">
                                    <span class="font-mono text-sm font-medium text-purple-600 dark:text-purple-400 w-24" x-text="criteriaId"></span>
                                    <span class="text-sm text-gray-700 dark:text-gray-200 flex-1" x-text="getGovernmentCriteriaName(criteriaId)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: ENHANCED DATA (Tool 25 - Scrapy) -->
                <div x-show="activeTab === 'enhanced'" class="space-y-4">
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-green-900 dark:text-green-100 mb-2">
                            Web Intelligence (Tool 25)
                        </h4>
                        <p class="text-sm text-green-700 dark:text-green-300 mb-3">
                            Data automatically scraped from your organization's website and IRS filings using Tool 25.
                        </p>
                    </div>

                    <!-- Loading State -->
                    <div x-show="scrapingLoading" class="text-center py-12 border-2 border-dashed border-green-300 dark:border-green-600 rounded-lg bg-green-50 dark:bg-green-900/10">
                        <div class="flex justify-center mb-4">
                            <svg class="animate-spin h-12 w-12 text-green-600" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-green-900 dark:text-green-100">Running Enhanced Search...</h3>
                        <p class="mt-2 text-sm text-green-700 dark:text-green-300">
                            Running comprehensive web intelligence search using scrapy tool. This may take 10-60 seconds.
                        </p>
                    </div>

                    <!-- Enhanced Data Display - With Results -->
                    <div x-show="!scrapingLoading && profile.web_enhanced_data" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Website URL -->
                            <div x-show="profile.website_url || profile.web_enhanced_data?.website_url">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Website</label>
                                <a :href="profile.web_enhanced_data?.website_url || profile.website_url"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 hover:underline inline-flex items-center"
                                   x-text="profile.web_enhanced_data?.website_url || profile.website_url">
                                </a>
                                <svg class="inline-block w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </div>

                            <!-- Phone -->
                            <div x-show="profile.web_enhanced_data?.phone">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
                                <p class="text-sm text-gray-900 dark:text-white" x-text="profile.web_enhanced_data?.phone"></p>
                            </div>

                            <!-- Location -->
                            <div x-show="profile.web_enhanced_data?.location || profile.location">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                                <p class="text-sm text-gray-900 dark:text-white" x-text="profile.web_enhanced_data?.location || profile.location"></p>
                            </div>

                            <!-- Email -->
                            <div x-show="profile.web_enhanced_data?.email">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                                <a :href="'mailto:' + profile.web_enhanced_data?.email"
                                   class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400"
                                   x-text="profile.web_enhanced_data?.email"></a>
                            </div>

                            <!-- Mission/Description -->
                            <div x-show="profile.web_enhanced_data?.mission || profile.web_enhanced_data?.description" class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mission/Description</label>
                                <p class="text-sm text-gray-900 dark:text-white leading-relaxed" x-text="profile.web_enhanced_data?.mission || profile.web_enhanced_data?.description"></p>
                            </div>
                        </div>

                        <!-- Re-search Button (after data is found) -->
                        <div class="flex justify-end mt-4">
                            <button @click="$dispatch('run-tool-25', { ein: profile.ein })"
                                    :disabled="scrapingLoading || !profile.ein"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Re-run Enhanced Search
                            </button>
                        </div>
                    </div>

                    <!-- Ready to Search State (website exists but no enhanced data yet) -->
                    <div x-show="!scrapingLoading && !profile.web_enhanced_data && profile.website_url"
                         class="mt-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 text-center">
                        <svg class="mx-auto h-12 w-12 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                        </svg>
                        <h3 class="mt-4 text-sm font-medium text-blue-900 dark:text-blue-100">Website Found - Ready to Search</h3>
                        <p class="mt-2 text-sm text-blue-700 dark:text-blue-300 mb-4">
                            Click below to run Enhanced Search and gather comprehensive web intelligence from:
                            <br/>
                            <a :href="profile.website_url" target="_blank" class="underline hover:text-blue-800" x-text="profile.website_url"></a>
                        </p>
                        <button @click="$dispatch('run-tool-25', { ein: profile.ein })"
                                :disabled="scrapingLoading || !profile.ein"
                                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center font-medium">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Run Enhanced Search
                        </button>
                    </div>

                    <!-- No Website State (need to add website first) -->
                    <div x-show="!scrapingLoading && !profile.web_enhanced_data && !profile.website_url"
                         class="text-center py-12 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                        </svg>
                        <h3 class="mt-4 text-sm font-medium text-gray-900 dark:text-white">No Website Information</h3>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            Add a website URL in the Basic Information tab, then come back here to run Enhanced Search.
                        </p>
                        <button @click="activeTab = 'basic'"
                                class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                            Go to Basic Info
                        </button>
                    </div>
                </div>

                <!-- TAB 5: USER SPECIFIC -->
                <div x-show="activeTab === 'userspecific'" class="space-y-4">
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-orange-900 dark:text-orange-100 mb-2">
                            Custom Profile Configuration
                        </h4>
                        <p class="text-sm text-orange-700 dark:text-orange-300">
                            Add reference files, notes, and custom tags specific to this profile.
                        </p>
                    </div>

                    <!-- Custom Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Internal Notes
                        </label>
                        <textarea x-model="profile.user_notes"
                                  rows="4"
                                  placeholder="Add internal notes, reminders, or strategy notes..."
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:text-white"></textarea>
                    </div>

                    <!-- Custom Tags -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Custom Tags
                        </label>
                        <input type="text"
                               x-model="profile.custom_tags"
                               placeholder="high-priority, board-connection, recurring-grant"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:text-white">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Comma-separated tags for organization and filtering
                        </p>
                    </div>

                    <!-- Reference Files -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Reference Files
                        </label>

                        <!-- Hidden File Input -->
                        <input type="file"
                               x-ref="fileInput"
                               @change="handleFileSelect"
                               multiple
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"
                               class="hidden">

                        <!-- File Upload Area -->
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                Click to select files for upload
                            </p>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                PDFs, Word docs, Excel files up to 10MB each
                            </p>
                            <button @click="triggerFileInput()"
                                    type="button"
                                    class="mt-3 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                                Browse Files
                            </button>
                        </div>

                        <!-- Selected Files (Before Upload) -->
                        <div x-show="selectedFiles.length > 0" class="mt-4 space-y-2">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Selected Files (<span x-text="selectedFiles.length"></span>)
                                </h4>
                                <button @click="uploadFiles()"
                                        class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors">
                                    Upload Files
                                </button>
                            </div>
                            <template x-for="(file, index) in selectedFiles" :key="index">
                                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 flex-1 min-w-0">
                                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-900 dark:text-white truncate" x-text="file.name"></span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0" x-text="formatFileSize(file.size)"></span>
                                    </div>
                                    <button @click="removeFile(index)"
                                            class="ml-2 p-1 text-red-600 hover:text-red-700 dark:text-red-400 flex-shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <!-- Uploaded Files (After Upload) -->
                        <div x-show="uploadedFiles.length > 0" class="mt-4 space-y-2">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Uploaded Files (<span x-text="uploadedFiles.length"></span>)
                            </h4>
                            <template x-for="(file, index) in uploadedFiles" :key="index">
                                <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-700">
                                    <div class="flex items-center space-x-2 flex-1">
                                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <a :href="file.url" target="_blank" class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 hover:underline" x-text="file.name"></a>
                                        <span class="text-xs text-gray-500" x-text="file.uploaded_at"></span>
                                    </div>
                                    <button @click="uploadedFiles.splice(index, 1)"
                                            class="ml-2 text-red-600 hover:text-red-700 dark:text-red-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <!-- Note about file upload endpoint -->
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 italic">
                            Note: File upload functionality requires backend endpoint implementation.
                        </p>
                    </div>
                </div>

                <!-- Error Display -->
                <div x-show="error"
                     class="mt-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4"
                     x-transition>
                    <p class="text-red-600 dark:text-red-400 text-sm" x-text="error"></p>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 px-6 py-4 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600">
                <button @click="modalOpen = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button @click="saveProfile()"
                        :disabled="loading"
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <span x-show="!loading">Update Profile</span>
                    <span x-show="loading" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Saving...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- NESTED: NTEE CODE SELECTION MODAL                           -->
    <!-- ============================================================ -->
    <!-- No separate x-data - inherits from parent Edit Profile Modal -->
    <div x-show="nteeSelectionModalOpen"
         x-cloak
         @click.self="closeNteeSelectionModal()"
         class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4"
         style="display: none;">

        <div @click.stop
             class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-5xl w-full max-h-[85vh] overflow-hidden"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100">

            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 bg-blue-600 text-white">
                <h3 class="text-lg font-semibold">Select NTEE Codes</h3>
                <button @click="closeNteeSelectionModal()"
                        class="text-white hover:text-gray-200 transition-colors">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>

            <!-- Two Column Selection Interface -->
            <div class="flex h-[60vh]">
                <!-- Left Column: Main Categories (A-Z) with Visual Indicators -->
                <div class="w-2/5 border-r border-gray-200 dark:border-gray-600 flex flex-col bg-gray-50 dark:bg-gray-900">
                    <div class="px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Main Categories</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <template x-for="(categoryData, categoryKey) in (fullNteeCodeList || {})" :key="categoryKey">
                            <div class="mb-1">
                                <button @click="selectMainCategory(categoryKey)"
                                        :class="selectedMainCategory === categoryKey ?
                                            'bg-blue-100 dark:bg-blue-900 border-blue-300 dark:border-blue-600 text-blue-900 dark:text-blue-100' :
                                            categoryHasTempSelections(categoryKey) ?
                                            'bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700 text-green-800 dark:text-green-200 hover:bg-green-100 dark:hover:bg-green-800' :
                                            'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                        class="w-full text-left p-2 border rounded-md transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2 flex-1">
                                            <span class="font-bold text-sm" x-text="categoryKey"></span>
                                            <span class="text-xs truncate flex-1" x-text="categoryData.category"></span>
                                        </div>
                                        <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded flex-shrink-0 ml-2"
                                              x-text="categoryData.subcategories?.length || 0"></span>
                                    </div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Right Column: Subcategories with Visual Indicators -->
                <div class="w-3/5 flex flex-col">
                    <div class="px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                            <span x-show="!selectedMainCategory">Select a main category to view subcategories</span>
                            <span x-show="selectedMainCategory" x-text="selectedMainCategory + ' - ' + ((fullNteeCodeList || {})[selectedMainCategory]?.category || '')"></span>
                        </h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-gray-800">
                        <div x-show="!selectedMainCategory" class="text-center text-gray-500 dark:text-gray-400 py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            <p class="text-sm">Choose a main category from the left to view its subcategories</p>
                        </div>

                        <div x-show="selectedMainCategory" class="space-y-1">
                            <template x-for="subcat in ((fullNteeCodeList || {})[selectedMainCategory]?.subcategories || [])" :key="subcat.code">
                                <div @click="toggleTempNteeCode(subcat.code)"
                                     :class="isTempCodeSelected(subcat.code) ?
                                        'bg-blue-600 text-white border-blue-600' :
                                        'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                     class="flex items-center p-3 border rounded-md cursor-pointer transition-colors">
                                    <div class="flex items-center space-x-3 flex-1">
                                        <span class="font-medium text-sm" x-text="subcat.code"></span>
                                        <span class="text-sm" x-text="subcat.name"></span>
                                    </div>
                                    <div x-show="isTempCodeSelected(subcat.code)" class="ml-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer with Cancel and Save Buttons -->
            <div class="flex items-center justify-between px-6 py-4 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600">
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    <span x-text="(tempNteeCodes || []).length"></span> code(s) selected
                </div>
                <div class="flex items-center space-x-3">
                    <button @click="closeNteeSelectionModal()"
                            class="px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                        Cancel
                    </button>
                    <button @click="saveNteeSelection()"
                            class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Save NTEE Codes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- NESTED: GOVERNMENT CRITERIA SELECTION MODAL                 -->
    <!-- ============================================================ -->
    <!-- No separate x-data - inherits from parent Edit Profile Modal -->
    <div x-show="governmentSelectionModalOpen"
         x-cloak
         @click.self="closeGovernmentSelectionModal()"
         class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4"
         style="display: none;">

        <div @click.stop
             class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-5xl w-full max-h-[85vh] overflow-hidden"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100">

            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 bg-purple-600 text-white">
                <h3 class="text-lg font-semibold">Select Government Criteria</h3>
                <button @click="closeGovernmentSelectionModal()"
                        class="text-white hover:text-gray-200 transition-colors">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>

            <!-- Two Column Selection Interface -->
            <div class="flex h-[60vh]">
                <!-- Left Column: Criteria Categories with Visual Indicators -->
                <div class="w-2/5 border-r border-gray-200 dark:border-gray-600 flex flex-col bg-gray-50 dark:bg-gray-900">
                    <div class="px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Criteria Categories</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <template x-for="(categoryData, categoryKey) in (governmentCriteriaList || {})" :key="categoryKey">
                            <div class="mb-1">
                                <button @click="selectGovernmentCategory(categoryKey)"
                                        :class="selectedGovernmentCategory === categoryKey ?
                                            'bg-purple-100 dark:bg-purple-900 border-purple-300 dark:border-purple-600 text-purple-900 dark:text-purple-100' :
                                            categoryHasGovernmentSelections(categoryKey) ?
                                            'bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700 text-green-800 dark:text-green-200 hover:bg-green-100 dark:hover:bg-green-800' :
                                            'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                        class="w-full text-left px-3 py-2 text-sm border rounded-md transition-colors">
                                    <div class="font-medium" x-text="categoryData.category"></div>
                                    <div class="text-xs opacity-75 mt-1" x-text="categoryData.description"></div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Right Column: Criteria Items with Visual Indicators -->
                <div class="w-3/5 flex flex-col">
                    <div class="px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                            <span x-show="!selectedGovernmentCategory">Select a category to view criteria</span>
                            <span x-show="selectedGovernmentCategory" x-text="((governmentCriteriaList || {})[selectedGovernmentCategory]?.category || '')"></span>
                        </h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-gray-800">
                        <div x-show="!selectedGovernmentCategory" class="text-center text-gray-500 dark:text-gray-400 py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <p class="text-sm">Choose a category from the left to view criteria options</p>
                        </div>

                        <div x-show="selectedGovernmentCategory" class="space-y-2">
                            <template x-for="criteria in ((governmentCriteriaList || {})[selectedGovernmentCategory]?.criteria || [])" :key="criteria.id">
                                <div @click="toggleGovernmentCriteria(criteria.id)"
                                     :class="isGovernmentCriteriaSelected(criteria.id) ?
                                        'bg-purple-600 text-white border-purple-600' :
                                        'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                     class="flex items-start p-3 border rounded-md cursor-pointer transition-colors">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm" x-text="criteria.name"></div>
                                        <!-- Source badges -->
                                        <div class="flex flex-wrap gap-1 mt-2">
                                            <template x-for="source in (criteria.sources || [])" :key="source">
                                                <span :class="source === 'Federal' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                                               source === 'State' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                                                               'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'"
                                                      class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                      x-text="source">
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                    <div x-show="isGovernmentCriteriaSelected(criteria.id)" class="ml-2 flex-shrink-0">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer with Cancel and Save Buttons -->
            <div class="flex items-center justify-between px-6 py-4 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600">
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    <span x-text="(tempGovernmentCriteria || []).length"></span> criteria selected
                </div>
                <div class="flex items-center space-x-3">
                    <button @click="closeGovernmentSelectionModal()"
                            class="px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                        Cancel
                    </button>
                    <button @click="saveGovernmentSelection()"
                            class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                        Save Government Criteria
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
